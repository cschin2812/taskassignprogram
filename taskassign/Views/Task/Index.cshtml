@model taskassign.Models.TaskQueryViewModel
@using taskassign.Models
@{
    ViewData["Title"] = "Tasks";
    var showGroupColumn = Model.SelectedGroupId == 0;
    var groupNameMap = ViewBag.TaskGroupNameMap as Dictionary<int, string> ?? new Dictionary<int, string>();
    var leadGroupIds = ViewBag.LeadGroupIds as HashSet<int> ?? new HashSet<int>();
    var currentUsername = ViewBag.CurrentUsername as string ?? User.Identity?.Name ?? string.Empty;
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h2 class="mb-0">Tasks (List)</h2>
        <small class="text-muted">Group: @Model.ActiveGroupName</small>
    </div>
    @if ((ViewBag.CanManageTasks as bool?) == true)
    {
        <a asp-action="Create" class="btn btn-primary">+ Create Task</a>
    }
</div>

<div class="mb-3">
    <a class="btn btn-sm btn-outline-dark me-2" asp-action="Index">List View</a>
    <a class="btn btn-sm btn-outline-primary" asp-action="Board">Board View</a>
</div>

<form id="taskFilterForm" method="get" class="row g-2 mb-4">
    <div class="col-md-3"><input id="searchFilter" name="search" value="@Model.Search" class="form-control js-auto-filter-text" placeholder="Search title/description" /></div>
    <div class="col-md-2">
        <select name="groupId" class="form-select js-auto-filter-select">
            @if (Model.SelectedGroupId == 0)
            {
                <option value="0" selected>All Groups</option>
            }
            else
            {
                <option value="0">All Groups</option>
            }
            @foreach (var group in (ViewBag.TaskGroups as List<taskassign.Models.GroupInfo> ?? new List<taskassign.Models.GroupInfo>()))
            {
                if (group.Id == Model.SelectedGroupId)
                {
                    <option value="@group.Id" selected>@group.Name</option>
                }
                else
                {
                    <option value="@group.Id">@group.Name</option>
                }
            }
        </select>
    </div>
    <div class="col-md-2"><select asp-for="Status" asp-items="Html.GetEnumSelectList<taskassign.Models.TaskStatus>()" class="form-select js-auto-filter-select"><option value="">All Status</option></select></div>
    <div class="col-md-2"><select asp-for="Priority" asp-items="Html.GetEnumSelectList<taskassign.Models.TaskPriority>()" class="form-select js-auto-filter-select"><option value="">All Priority</option></select></div>
    <div class="col-md-2"><input name="assignedTo" value="@Model.AssignedTo" class="form-control js-auto-filter-text" placeholder="Assignee" /></div>
    <div class="col-md-1 d-flex justify-content-end">
        <a class="btn btn-outline-secondary" asp-action="Index">Reset</a>
    </div>
</form>

<div id="taskListContainer">
<table class="table table-striped table-fixed" id="taskListTable">
    <colgroup>
        <col class="col-title" />
        @if (showGroupColumn)
        {
            <col class="col-group" />
        }
        <col class="col-assignee" />
        <col class="col-status" />
        <col class="col-priority" />
        <col class="col-due" />
        <col class="col-duein" />
        <col class="col-action" />
    </colgroup>
    <thead><tr><th>Title</th>@if (showGroupColumn) { <th>Group</th> }<th>Assignee</th><th>Status</th><th>Priority</th><th>Due</th><th>Due In</th><th>Action</th></tr></thead>
    <tbody id="taskListBody">
    @if (!Model.Tasks.Any())
    {
        <tr>
            <td colspan="@(showGroupColumn ? 8 : 7)" class="text-center text-muted">No any task in this group</td>
        </tr>
    }
    else
    {
        @foreach (var task in Model.Tasks)
        {
            <tr>
                <td class="task-title-cell"><strong>@task.Title</strong><div class="small text-muted task-description-ellipsis">@task.Description</div></td>
                @if (showGroupColumn)
                {
                    <td>@(groupNameMap.TryGetValue(task.GroupId, out var groupName) ? groupName : $"Group #{task.GroupId}")</td>
                }
                <td>@task.AssignedTo</td>
                <td>@task.Status</td>
                <td><span class="fw-semibold @task.PriorityClass">@task.Priority</span></td>
                <td>@task.DueDate.ToString("yyyy-MM-dd")</td>
                <td>
                    @if (task.Status != taskassign.Models.TaskStatus.Completed && task.Status != taskassign.Models.TaskStatus.Closed)
                    {
                        <span class="fw-semibold @task.DueDateStatusClass">@task.DueDateStatusText</span>
                    }
                </td>
                <td>
                    @if (leadGroupIds.Contains(task.GroupId) || string.Equals(task.AssignedTo, currentUsername, StringComparison.OrdinalIgnoreCase))
                    {
                        <a asp-action="Edit" asp-route-id="@task.Id" class="btn btn-sm btn-outline-primary">Edit</a>
                    }
                    @if ((ViewBag.CanManageTasks as bool?) == true)
                    {
                        <button type="button"
                                class="btn btn-sm btn-outline-danger js-confirm-task-delete"
                                data-task-id="@task.Id"
                                data-task-title="@task.Title"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteTaskModal">
                            Delete
                        </button>
                    }
                </td>
            </tr>
        }
    }
    </tbody>
</table>

@if (Model.TotalPages > 1)
{
    <nav aria-label="Task list pages">
        <ul class="pagination justify-content-center">
            @for (var i = 1; i <= Model.TotalPages; i++)
            {
                <li class="page-item @(i == Model.PageNumber ? "active" : string.Empty)">
                    <a class="page-link" asp-action="Index" asp-route-page="@i" asp-route-search="@Model.Search" asp-route-groupId="@Model.SelectedGroupId" asp-route-status="@Model.Status" asp-route-priority="@Model.Priority" asp-route-assignedTo="@Model.AssignedTo">@i</a>
                </li>
            }
        </ul>
    </nav>
}
</div>

<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete task <strong id="deleteTaskName"></strong>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteTaskForm" asp-action="Delete" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <input id="deleteTaskId" type="hidden" name="id" value="" />
                    <button class="btn btn-danger" type="submit">Confirm Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    #taskListTable.table-fixed {
        table-layout: fixed;
        width: 100%;
    }

    #taskListTable .col-title { width: 30%; }
    #taskListTable .col-group { width: 11%; }
    #taskListTable .col-assignee { width: 11%; }
    #taskListTable .col-status { width: 7%; }
    #taskListTable .col-priority { width: 7%; }
    #taskListTable .col-due { width: 8%; }
    #taskListTable .col-duein { width: 9%; }
    #taskListTable .col-action { width: 9%; }

    #taskListTable td,
    #taskListTable th {
        word-wrap: break-word;
        overflow-wrap: anywhere;
        vertical-align: top;
    }

    #taskListTable .task-description-ellipsis {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.35;
        max-height: calc(1.35em * 2);
    }
</style>

@section Scripts {
<script>
(() => {
    const filterForm = document.getElementById('taskFilterForm');
    let taskContainer = document.getElementById('taskListContainer');
    let taskTable = document.getElementById('taskListTable');
    const idInput = document.getElementById('deleteTaskId');
    const nameContainer = document.getElementById('deleteTaskName');

    if (!filterForm || !taskContainer || !taskTable || !idInput || !nameContainer) {
        return;
    }

    const bindDeleteButtons = () => {
        document.querySelectorAll('.js-confirm-task-delete').forEach(btn => {
            btn.addEventListener('click', () => {
                idInput.value = btn.getAttribute('data-task-id') || '';
                nameContainer.textContent = btn.getAttribute('data-task-title') || '';
            });
        });
    };

    const syncFormFromUrl = (url) => {
        const params = url.searchParams;
        filterForm.querySelectorAll('input[name], select[name]').forEach(control => {
            const paramValue = params.get(control.name);
            if (paramValue === null) {
                if (control.tagName === 'SELECT') {
                    control.value = '';
                } else {
                    control.value = '';
                }
            } else {
                control.value = paramValue;
            }
        });
    };

    const refreshTable = async () => {
        const activeElement = document.activeElement;
        const activeName = activeElement?.getAttribute?.('name');
        const selectionStart = activeElement?.selectionStart ?? null;
        const selectionEnd = activeElement?.selectionEnd ?? null;

        const params = new URLSearchParams(new FormData(filterForm));
        const url = new URL(window.location.href);
        url.search = params.toString();

        const response = await fetch(url.toString(), {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (!response.ok) {
            return;
        }

        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        const nextContainer = doc.getElementById('taskListContainer');
        if (!nextContainer || !taskContainer) {
            return;
        }

        taskContainer.outerHTML = nextContainer.outerHTML;
        taskContainer = document.getElementById('taskListContainer');
        taskTable = document.getElementById('taskListTable');
        history.replaceState(null, '', url.toString());
        bindDeleteButtons();

        if (activeName) {
            const nextInput = filterForm.querySelector(`[name="${activeName}"]`);
            if (nextInput instanceof HTMLInputElement || nextInput instanceof HTMLTextAreaElement) {
                nextInput.focus();
                if (selectionStart !== null && selectionEnd !== null) {
                    nextInput.setSelectionRange(selectionStart, selectionEnd);
                }
            }
        }
    };

    const textInputs = filterForm.querySelectorAll('.js-auto-filter-text');
    const selectInputs = filterForm.querySelectorAll('.js-auto-filter-select');

    textInputs.forEach(input => {
        input.addEventListener('input', () => {
            void refreshTable();
        });

        input.addEventListener('keydown', event => {
            if (event.key === 'Enter') {
                event.preventDefault();
                void refreshTable();
            }
        });
    });

    selectInputs.forEach(select => {
        select.addEventListener('change', () => {
            void refreshTable();
        });
    });

    filterForm.querySelectorAll('a[href]').forEach(link => {
        if (link.textContent?.trim() === 'Reset') {
            link.addEventListener('click', event => {
                event.preventDefault();
                const target = new URL(link.getAttribute('href') || '', window.location.origin);
                history.replaceState(null, '', target.toString());
                syncFormFromUrl(target);
                void refreshTable();
            });
        }
    });

    bindDeleteButtons();
})();
</script>
}
